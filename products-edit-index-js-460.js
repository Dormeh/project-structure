"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[460],{842:(e,t,s)=>{s.d(t,{Z:()=>n});class n{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",{duration:t=1e3,type:s="success"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var i,r,o;o=void 0,(r="element")in(i=this)?Object.defineProperty(i,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):i[r]=o,this.duration=t,this.message=e,this.type=s,this.render(),n.isAlreadyShow?n.isAlreadyShow.remove(n.isAlreadyShow):n.isAlreadyShow=!1}getTemplate(){return`<div class="notification" style="--value:2s">\n    <div class="timer"></div>\n    <div class="inner-wrapper">\n      <div class="notification-header">${this.type}</div>\n      <div class="notification-body">${this.message}</div>\n    </div>\n  </div>`}render(){const e=document.createElement("div");e.innerHTML=this.getTemplate(),this.element=e.firstElementChild,this.element.classList.add(this.type)}show(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body).append(this.element),n.isAlreadyShow=this.element;setTimeout(()=>this.remove(),this.duration);return this.element}remove(){this.element.remove()}destroy(){this.remove()}}},523:(e,t,s)=>{function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{Z:()=>i});class i{constructor(){let{items:e=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,"onPointerDown",e=>{const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&(e.preventDefault(),this.elMove=t,this.elShift=e.pageY-t.getBoundingClientRect().top,e.preventDefault(),this.dragStart(t,e)),e.target.closest("[data-delete-handle]")&&this.removeItem(t))}),n(this,"onDocumentPointerMove",e=>{this.moveDraggingAt(e.clientX,e.clientY),this.elMove.style.display="none";let t=document.elementFromPoint(e.clientX,e.clientY);if(this.elMove.style.display="",!t)return;const s=t.closest(".sortable-list__item");if(!t.closest(".sortable-list__placeholder")&&s){const e=[...this.element.children].indexOf(s);if(e>this.element.children.length||e<0)return;const t=s.getBoundingClientRect().top>this.placeholderElem.getBoundingClientRect().top?1:0;this.movePlaceholderAt(s,t)}}),n(this,"onDocumentPointerUp",()=>{this.dragStop()}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.classList.add("sortable-list");for(const e of this.items)this.addItem(e);this.element.addEventListener("pointerdown",this.onPointerDown)}addItem(e){e.classList.add("sortable-list__item"),this.element.append(e)}removeItem(e){e.remove(),this.element.dispatchEvent(new CustomEvent("sortable-list-delete",{bubbles:!0,details:{item:e}}))}dragStart(e,t){let{clientX:s,clientY:n}=t;this.elementInitialIndex=[...this.element.children].indexOf(e),this.elShift={x:s-e.getBoundingClientRect().x,y:n-e.getBoundingClientRect().y},this.elMove=e,this.placeholderElem=document.createElement("div"),this.placeholderElem.className="sortable-list__placeholder",e.style.width=e.offsetWidth+"px",e.style.height=e.offsetHeight+"px",this.placeholderElem.style.width=e.style.width,this.placeholderElem.style.height=e.style.height,e.classList.add("sortable-list__item_dragging"),e.after(this.placeholderElem),this.element.append(e),this.moveDraggingAt(s,n),document.addEventListener("pointermove",this.onDocumentPointerMove),document.addEventListener("pointerup",this.onDocumentPointerUp)}moveDraggingAt(e,t){this.elMove.style.left=e-this.elShift.x+"px",this.elMove.style.top=t-this.elShift.y+"px"}movePlaceholderAt(e,t){t?e.after(this.placeholderElem):e.before(this.placeholderElem)}dragStop(){const e=[...this.element.children].indexOf(this.placeholderElem);this.placeholderElem.replaceWith(this.elMove),this.elMove.classList.remove("sortable-list__item_dragging"),this.elMove.style.width="",this.elMove.style.height="",this.elMove.style.left="",this.elMove.style.top="",this.placeholderElem.remove(),document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp),this.elMove=null,e!==this.elementInitialIndex&&this.element.dispatchEvent(new CustomEvent("sortable-list-reorder",{bubbles:!0,detail:{item:this.element}}))}remove(){this.element.remove()}destroy(){this.element.removeEventListener("pointerdown",this.onPointerDown),document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp),this.element.remove()}}},311:(e,t,s)=>{s.r(t),s.d(t,{default:()=>c});var n=s(523);const i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var r=s(856);s(935);function o(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class a{constructor(e){o(this,"subElements",{}),o(this,"defaultFormData",[{title:"",description:"",quantity:1,subcategory:"",status:1,images:[],price:100,discount:0}]),o(this,"onSubmit",e=>{e.preventDefault(),this.save()}),o(this,"uploadImage",()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=async()=>{const[t]=e.files;if(!t)return;let s;const n=new FormData;n.append("image",t),this.subElements.productForm.uploadImage.classList.add("is-loading"),this.subElements.productForm.uploadImage.disabled=!0;try{s=await(0,r.Z)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:n,referrer:""})}catch(e){return new Error("Upload error: "+e.message)}finally{this.subElements.productForm.uploadImage.classList.remove("is-loading"),this.subElements.productForm.uploadImage.disabled=!1}this.formData.images.push({url:s.data.link,source:t.name}),this.imageList.addItem(this.renderImageElem({url:s.data.link,source:t.name}))},e.hidden=!0,document.body.appendChild(e),e.click()}),this.productId=e}template(){return`<div class="products-edit">\n      <div class="content__top-panel">\n        <h1 class="page-title">\n          <a href="/products" class="link">Товары</a> / ${this.productId?"Редактировать":"Добавить"}\n        </h1>\n      </div>\n      <div class="content-box">\n\n    <div class="product-form">\n    \n    <form data-element="productForm" class="form-grid">\n      <div class="form-group form-group__half_left">\n        <fieldset>\n          <label class="form-label">Название товара</label>\n          <input required="" type="text" name="title" class="form-control" placeholder="Название товара">\n        </fieldset>\n      </div>\n      \n      <div class="form-group form-group__wide">\n        <label class="form-label">Описание</label>\n        <textarea required="" class="form-control" name="description" data-element="productDescription" placeholder="Описание товара"></textarea>\n      </div>\n      \n      <div class="form-group form-group__wide" data-element="sortable-list-container">\n        <label class="form-label">Фото</label>\n\n        <div data-element="imageListContainer">\n        </div>\n\n        <button type="button" name="uploadImage" class="button-primary-outline fit-content"><span>Загрузить</span></button>\n      </div>\n      \n      <div class="form-group form-group__half_left">\n        <label class="form-label">Категория</label>\n        <select class="form-control" name="subcategory">\n            ${this.createCategoriesSelect()}\n        </select>\n      </div>\n      \n      <div class="form-group form-group__half_left form-group__two-col">\n        <fieldset>\n          <label class="form-label">Цена ($)</label>\n          <input required="" type="number" name="price" class="form-control" placeholder="${this.defaultFormData.price}">\n        </fieldset>\n        <fieldset>\n          <label class="form-label">Скидка ($)</label>\n          <input required="" type="number" name="discount" class="form-control" placeholder="${this.defaultFormData.discount}">\n        </fieldset>\n      </div>\n      \n      <div class="form-group form-group__part-half">\n        <label class="form-label">Количество</label>\n        <input required="" type="number" class="form-control" name="quantity" placeholder="${this.defaultFormData.quantity}">\n      </div>\n      <div class="form-group form-group__part-half">\n        <label class="form-label">Статус</label>\n        <select class="form-control" name="status">\n          <option value="1">Активен</option>\n          <option value="0">Неактивен</option>\n        </select>\n      </div>\n      <div class="form-buttons">\n        <button type="submit" name="save" class="button-primary-outline">\n          ${this.productId?"Сохранить":"Добавить"} товар\n        </button>\n      </div>\n    </form>\n  </div>\n  </div>\n`}async render(){const e=this.loadCategoriesList(),t=this.productId?this.loadProductData(this.productId):Promise.resolve(this.defaultFormData),[s,n]=await Promise.all([e,t]),[i]=n;if(this.formData=i,this.categories=s,this.renderForm(),this.formData)return this.setFormData(),this.initEventListeners(),this.element}renderForm(){const e=document.createElement("div");e.innerHTML=this.formData?this.template():this.qetEmptyTemplate(),this.element=e.firstElementChild,this.getSubElements(e);const t=this.createImagesList();this.imageList=new n.Z({items:t}),this.subElements.imageListContainer.append(this.imageList.element);const s=this.formData.subcategory,i=[...this.subElements.productForm.subcategory.options].find(e=>e.value===s);i&&(i.selected=!0)}qetEmptyTemplate(){return'<div class="error-404">\n      <h1 class="page-title">Страница не найдена</h1>\n      <p>Извините, страница не существует</p>\n    </div>'}getSubElements(e){const t=e.querySelectorAll("[data-element]");for(const e of t)this.subElements[e.dataset.element]=e}async loadProductData(){return(0,r.Z)("https://course-js.javascript.ru/api/rest/products?id="+this.productId)}async loadCategoriesList(){return(0,r.Z)("https://course-js.javascript.ru/api/rest/categories?_sort=weight&_refs=subcategory")}setFormData(){const{title:e,description:t,price:s,discount:n,quantity:i,status:r}=this.formData;this.subElements.productForm.title.value=e,this.subElements.productForm.description.value=t,this.subElements.productForm.price.value=s,this.subElements.productForm.discount.value=n,this.subElements.productForm.quantity.value=i,this.subElements.productForm.status.value=r}createCategoriesSelect(){return this.categories.map(e=>e.subcategories.map(t=>`<option value="${t.id}">${e.title} > ${t.title}</option>`).join("")).join("")}async save(){const e=this.getFormData();try{const t=await(0,r.Z)("https://course-js.javascript.ru//api/rest/products",{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=this.productId?new CustomEvent("product-saved",{detail:t.id}):new CustomEvent("product-updated",{detail:t.id});this.element.dispatchEvent(s)}catch(e){console.error("Ошибка в отправке формы",e)}}getFormData(){const{productForm:e}=this.subElements,{title:t,description:s,subcategory:n,price:i,quantity:r,discount:o,status:a}=e;return{id:this.productId,title:t.value,description:s.value,subcategory:n.value,price:parseInt(i.value,10),quantity:parseInt(r.value,10),discount:parseInt(o.value,10),status:parseInt(a.value,10),images:this.formData.images}}initEventListeners(){const{productForm:e,imageListContainer:t}=this.subElements;e.addEventListener("submit",this.onSubmit),e.uploadImage.addEventListener("click",this.uploadImage),t.addEventListener("click",e=>{"deleteHandle"in e.target.dataset&&e.target.closest("li").remove()})}createImagesList(){return this.formData?this.formData.images.map(e=>this.renderImageElem(e)):""}renderImageElem(e){let{url:t,source:s}=e;const n=document.createElement("li");return n.classList.add("products-edit__imagelist-item"),n.innerHTML=`<input type="hidden" name="url" value="${t}">\n                    <input type="hidden" name="source" value="${s}">\n      <span>\n      <img src="/assets/icons/icon-grab.svg" data-grab-handle alt="grab">\n      <img class="sortable-table__cell-img" alt="Image" src="${i(t)}">\n      <span>${i(s)}</span>\n      </span>\n      <button type="button">\n      <img src="/assets/icons/icon-trash.svg" data-delete-handle alt="delete">\n      </button>`,n}remove(){this.element.remove()}destroy(){const{productForm:e}=this.subElements;e.uploadImage.removeEventListener("click",this.uploadImage),e.removeEventListener("submit",this.onSubmit),this.remove()}}var l=s(842);function d(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";d(this,"subElements",{}),d(this,"components",{}),d(this,"url",new URL("api/dashboard/bestsellers","https://course-js.javascript.ru/")),this.productId=e.replace(/products\/(.+)/,(function(){return"add"!==(arguments.length<=1?void 0:arguments[1])?arguments.length<=1?void 0:arguments[1]:""}))}initComponents(){const e=new a(this.productId);this.components={productForm:e}}async render(){return this.initComponents(),await this.components.productForm.render(),this.initEventListeners(),this.components.productForm.element}initEventListeners(){this.components.productForm.element.addEventListener("product-saved",e=>{console.error("product-saved",e.detail);new l.Z("Товар сохранен",{duration:2e3,type:"success"}).show()}),this.components.productForm.element.addEventListener("product-updated",e=>{console.error("product-updated",e.detail);new l.Z("Товар добавлен",{duration:2e3,type:"success"}).show()})}destroy(){this.subElements={};for(const e of Object.values(this.components))e.destroy()}}},856:(e,t,s)=>{async function n(e,t){let s,n;try{s=await fetch(e.toString(),t)}catch(e){throw new i(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{n=await s.json(),e=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new i(s,n,t)}try{return await s.json()}catch(e){throw new i(s,null,e.message)}}s.d(t,{Z:()=>n});class i extends Error{constructor(e,t,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof i&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js-460.js.map